pipeline{
	agent{
		kubernetes{
yaml '''
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: maven
    image: maven:3-openjdk-8
    command: ['sleep']
    args: ['infinity']
  - name: kaniko 
    image: gcr.io/kaniko-project/executor:debug
    command: ['sleep']
    args: ['infinity']
    volumeMounts:
    - name: registry-credentials
      mountPath: /kaniko/.docker
  voluems:
  - name: registry-credentials
    secret:
      secretName: regcred 
      items:
      - key: .dockerconfigjson
        path: config.json


'''
	}
    }
    triggers {
      pollSCM '* * * * *'
      }

    stages{
    	stage('checkout'){
	  steps{
	    container('maven'){
		  git branch: 'main', url:'https://github.com/suhwan12/abc.git'
		  }
		}
	}
	stage('maven build project'){
		steps{
		  container('maven'){
		    sh 'mvn clean package -DskipTests=true'
		    }
		 }
		}
	stage('test maven project'){
		steps{
			container('maven'){
				sh 'mvn test'
				}
		}
	}
	stage('Build & Tag docker image'){
	steps{
	  container('kaniko'){
	    sh "executor --dockerfile=Dockerfile \
	    --context=dir://${env.WORKSPACE} \
	    --destination=suhwan11/hello-world:latest \
	    --destination=suhwan11/hello-world:${env.BUILD_NUMBER}"
	}
}
